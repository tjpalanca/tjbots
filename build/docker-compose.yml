services:
  tjbots:
    container_name: ${DOCKER_NAME}
    image: ${DOCKER_IMG}:${VERSION}
    restart: always 
    build: &build
      context: ..
      dockerfile: build/Dockerfile
    volumes:
      - type: bind
        source: ${SECRETS_FILE-/run/secrets/tjbots.env}
        target: /run/secrets/tjbots.env
    ports:
      - "8080:8080"
  watchtower:
    profiles: 
      - production
    image: containrrr/watchtower:latest
    container_name: ${DOCKER_NAME}-watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: ${DOCKER_NAME} --interval 30 --cleanup
  tjbots-build:
    profiles: 
      - build
    build:
      <<: *build
      labels:
        org.opencontainers.image.source: ${REPO_URL-}
        org.opencontainers.image.licenses: ${LICENSE-}
      tags:
        - ${DOCKER_IMG}:${VERSION}
        - ${DOCKER_IMG}:${LATEST-latest}
      cache_from: 
        - ${DOCKER_IMG}:${CACHE-cache}
      cache_to: 
        - ${DOCKER_IMG}:${CACHE-cache}
      x-bake: 
        platforms: 
          - linux/amd64 
          - linux/arm64